# Production-ready docker-compose for coding-brain
# Phase 0.5: Infrastructure Prerequisites
#
# Required: Copy .env.example to .env and set all required values before running
#
# IMPORTANT: This is the CODING-BRAIN instance, completely separate from openmemory.
# All containers are prefixed with "codingbrain-" to avoid conflicts.
#
# Services:
# - PostgreSQL 16: Primary relational database with pgvector
# - Valkey 8: Cache and session store (Redis-compatible)
# - Neo4j 5: Graph database for code relationships
# - OpenSearch 2.13: Full-text and hybrid search
# - Qdrant 1.12: Vector database for embeddings
# - MCP API: The main application server
# - UI: The web interface

# Force project name to ensure all containers are prefixed with "codingbrain-"
name: codingbrain

networks:
  codingbrain-net:
    driver: bridge

services:
  # PostgreSQL 16 with pgvector for relational data and vector storage
  postgres:
    image: pgvector/pgvector:pg16
    container_name: codingbrain-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-codingbrain}
    ports:
      - "5532:5432"
    volumes:
      - codingbrain_postgres_data:/var/lib/postgresql/data
    networks:
      - codingbrain-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-codingbrain}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Valkey 8 - Redis-compatible cache and session store
  valkey:
    image: valkey/valkey:8.0.2-alpine
    container_name: codingbrain-valkey
    restart: unless-stopped
    ports:
      - "6479:6379"
    volumes:
      - codingbrain_valkey_data:/data
    networks:
      - codingbrain-net
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: valkey-server --appendonly yes

  # Qdrant vector database
  qdrant:
    image: qdrant/qdrant:v1.12.5
    container_name: codingbrain-qdrant
    restart: unless-stopped
    ports:
      - "6433:6333"
      - "6434:6334"  # gRPC port
    volumes:
      - codingbrain_qdrant_storage:/qdrant/storage
    networks:
      - codingbrain-net
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Ollama for local embeddings
  ollama:
    image: ollama/ollama:latest
    container_name: codingbrain-ollama
    profiles: ["docker-ollama"]
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - codingbrain_ollama:/root/.ollama
    networks:
      - codingbrain-net
    healthcheck:
      test: ["CMD-SHELL", "ollama list >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 20s

  # OpenSearch for full-text and hybrid search
  opensearch:
    image: opensearchproject/opensearch:2.13.0
    container_name: codingbrain-opensearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD}
      - bootstrap.memory_lock=true
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile: { soft: 65536, hard: 65536 }
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - codingbrain_opensearch_data:/usr/share/opensearch/data
    networks:
      - codingbrain-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200 >/dev/null || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # Neo4j graph database
  neo4j:
    image: neo4j:5.26.4-community
    container_name: codingbrain-neo4j
    restart: unless-stopped
    ports:
      - "7574:7474"
      - "7787:7687"
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME}/${NEO4J_PASSWORD}
      # Enable Graph Data Science and APOC plugins
      - NEO4J_PLUGINS=["graph-data-science", "apoc"]
      # Allow GDS and APOC procedures
      - NEO4J_dbms_security_procedures_unrestricted=gds.*,apoc.*
      - NEO4J_dbms_security_procedures_allowlist=gds.*,apoc.*
    volumes:
      - codingbrain_neo4j_data:/data
      - codingbrain_neo4j_logs:/logs
    networks:
      - codingbrain-net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # Main API/MCP server
  codingbrain-mcp:
    image: codingbrain/mcp
    container_name: codingbrain-mcp
    build: api/
    restart: unless-stopped
    environment:
      - USER=${USER}
      - API_KEY=${API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Default to host Ollama on macOS; override in env or GPU compose for Linux.
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_HOST=${OLLAMA_HOST:-host.docker.internal}
      - PYTHONPATH=/usr/src/openmemory:/usr/src/coding-brain
      # PostgreSQL connection
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-codingbrain}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-codingbrain}
      # Neo4j connection
      - NEO4J_URL=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
      # OpenSearch connection
      - OPENSEARCH_HOSTS=opensearch:9200
      # Qdrant connection
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      # Valkey connection
      - VALKEY_HOST=valkey
      - VALKEY_PORT=6379
      # Auto-migration for development (runs Alembic migrations on startup)
      - AUTO_MIGRATE=true
    env_file:
      - api/.env
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    ports:
      - "8865:8765"
    volumes:
      - ./api:/usr/src/openmemory
      - ..:/usr/src/coding-brain:ro
    networks:
      - codingbrain-net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8765/health/live')\""]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    command: >
      sh -c "uvicorn main:app --host 0.0.0.0 --port 8765 --reload --workers 4"

  # Documentation server (Docsify)
  codingbrain-docs:
    image: python:3.12-alpine
    container_name: codingbrain-docs
    restart: unless-stopped
    ports:
      - "3080:3080"
    volumes:
      - ../:/docs
    working_dir: /docs
    networks:
      - codingbrain-net
    command: sh -c "apk add --no-cache bash >/dev/null 2>&1 && bash ./scripts/generate-docs-sidebar.sh && python -m http.server 3080"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3080/docs/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # Indexing worker for background code indexing jobs
  codingbrain-indexing-worker:
    image: codingbrain/mcp
    container_name: codingbrain-indexing-worker
    restart: unless-stopped
    environment:
      - USER=${USER}
      - API_KEY=${API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PYTHONPATH=/usr/src/openmemory:/usr/src/coding-brain
      # PostgreSQL connection
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-codingbrain}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-codingbrain}
      # Neo4j connection
      - NEO4J_URL=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
      # OpenSearch connection
      - OPENSEARCH_HOSTS=opensearch:9200
      # Qdrant connection
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      # Valkey connection
      - VALKEY_HOST=valkey
      - VALKEY_PORT=6379
      # Worker-specific settings
      - WORKER_POLL_INTERVAL=1.0
      - WORKER_ORPHAN_RECOVERY_INTERVAL=60.0
      - WORKER_ORPHAN_TIMEOUT_MINUTES=5
      - WORKER_MAX_ATTEMPTS=3
    env_file:
      - api/.env
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    volumes:
      - ./api:/usr/src/openmemory
      - ..:/usr/src/coding-brain:ro
    networks:
      - codingbrain-net
    command: python -m app.workers.indexing_worker

  # Web UI
  codingbrain-ui:
    build:
      context: ui/
      dockerfile: Dockerfile
    image: codingbrain/ui:latest
    container_name: codingbrain-ui
    restart: unless-stopped
    ports:
      - "3433:3000"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_USER_ID=${USER}
      - NEXT_PUBLIC_API_TOKEN=${NEXT_PUBLIC_API_TOKEN}
    networks:
      - codingbrain-net
    depends_on:
      codingbrain-mcp:
        condition: service_healthy

volumes:
  codingbrain_postgres_data:
  codingbrain_valkey_data:
  codingbrain_qdrant_storage:
  codingbrain_ollama:
  codingbrain_neo4j_data:
  codingbrain_neo4j_logs:
  codingbrain_opensearch_data:
