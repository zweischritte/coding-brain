name: Security Scanning

on:
  push:
    branches: [main, coding-brain]
    paths:
      - 'openmemory/**'
      - '.github/workflows/security-scan.yml'
  pull_request:
    paths:
      - 'openmemory/**'
      - '.github/workflows/security-scan.yml'
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual trigger

env:
  IMAGE_NAME: codingbrain/mcp

jobs:
  # Job 1: Dependency vulnerability scanning with pip-audit
  dependency-scan:
    name: Dependency Scanning (pip-audit)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: openmemory/api
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: |
          pip-audit \
            --requirement requirements.txt \
            --format json \
            --output pip-audit-results.json \
            --strict \
            --desc on \
            || echo "Vulnerabilities found (see results)"
        continue-on-error: true

      - name: Upload pip-audit results
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-results
          path: openmemory/api/pip-audit-results.json
          retention-days: 30

      - name: Check for critical vulnerabilities
        run: |
          if [ -f pip-audit-results.json ]; then
            # Fail if HIGH or CRITICAL vulnerabilities found
            HIGH_COUNT=$(cat pip-audit-results.json | jq '[.dependencies[]? | select(.vulns != null) | .vulns[] | select(.fix_versions != null)] | length')
            echo "Found $HIGH_COUNT vulnerabilities with available fixes"
            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "::warning::Found $HIGH_COUNT dependency vulnerabilities with available fixes"
              cat pip-audit-results.json | jq '.dependencies[] | select(.vulns != null) | {name, version, vulns}'
            fi
          fi

  # Job 2: SAST scanning with Bandit
  sast-scan:
    name: SAST Scanning (Bandit)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: openmemory/api
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit
        run: |
          bandit -r app/ \
            -f sarif \
            -o bandit-results.sarif \
            --severity-level medium \
            --confidence-level medium \
            || echo "Issues found (see results)"
        continue-on-error: true

      - name: Upload Bandit SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: openmemory/api/bandit-results.sarif
          category: bandit
        continue-on-error: true  # Don't fail if SARIF upload fails

      - name: Upload Bandit results artifact
        uses: actions/upload-artifact@v4
        with:
          name: bandit-results
          path: openmemory/api/bandit-results.sarif
          retention-days: 30

      - name: Check for high severity issues
        run: |
          # Parse SARIF and fail on high severity
          HIGH_COUNT=$(cat bandit-results.sarif | jq '[.runs[].results[] | select(.level == "error" or .level == "warning")] | length' 2>/dev/null || echo "0")
          echo "Found $HIGH_COUNT high/medium severity issues"
          if [ "$HIGH_COUNT" -gt 10 ]; then
            echo "::error::Too many security issues found ($HIGH_COUNT)"
            exit 1
          fi

  # Job 3: Container vulnerability scanning with Trivy
  container-scan:
    name: Container Scanning (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container image
        uses: docker/build-push-action@v5
        with:
          context: openmemory/api
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          vuln-type: 'os,library'
          scanners: 'vuln,secret,misconfig'

      - name: Upload Trivy SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: trivy
        continue-on-error: true

      - name: Upload Trivy results artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.sarif
          retention-days: 30

      - name: Run Trivy and fail on critical
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'
          ignore-unfixed: true
          vuln-type: 'os,library'

  # Job 4: Secret scanning (check for accidentally committed secrets)
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for thorough scanning

      - name: Run Trivy secret scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          scanners: 'secret'
          severity: 'HIGH,CRITICAL'

  # Job 5: Dockerfile best practices with Hadolint
  dockerfile-lint:
    name: Dockerfile Linting (Hadolint)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: openmemory/api/Dockerfile
          format: sarif
          output-file: hadolint-results.sarif
          no-fail: true

      - name: Upload Hadolint SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: hadolint-results.sarif
          category: hadolint
        continue-on-error: true

      - name: Run Hadolint (fail on error)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: openmemory/api/Dockerfile
          failure-threshold: error

  # Summary job
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast-scan, container-scan, secret-scan, dockerfile-lint]
    if: always()
    steps:
      - name: Check scan results
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| pip-audit (Dependencies) | ${{ needs.dependency-scan.result == 'success' && ':white_check_mark:' || ':warning:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit (SAST) | ${{ needs.sast-scan.result == 'success' && ':white_check_mark:' || ':warning:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy (Container) | ${{ needs.container-scan.result == 'success' && ':white_check_mark:' || ':x:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy (Secrets) | ${{ needs.secret-scan.result == 'success' && ':white_check_mark:' || ':x:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Hadolint (Dockerfile) | ${{ needs.dockerfile-lint.result == 'success' && ':white_check_mark:' || ':warning:' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical issues
        if: ${{ needs.container-scan.result == 'failure' || needs.secret-scan.result == 'failure' }}
        run: |
          echo "::error::Critical security issues found. Please review the scan results."
          exit 1
